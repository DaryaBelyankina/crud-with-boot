<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>Admin panel</title>
</head>
<body>

<div class="container-fluid">
    <div class="row bg-dark text-white align-items-center">
        <header class="col float-left"><b th:text="${auth.getEmail()}"></b> with roles: <span th:text="${auth.getRolesInString()}"></span></header>
        <form class="col form-group" method="POST" th:action="@{/logout}">
            <input class="btn btn-dark float-right" type="submit" value="Logout">
        </form>
    </div>
</div>


<div class="container-fluid">
    <div class="row">
        <div class="col-2">
            <div class="p-1 btn-group-vertical w-100" role="group">
                <button sec:authorize="hasAuthority('ADMIN')" type="button" class="btn btn-primary btn-block text-left" formaction="/admin">Admin</button>
                <form sec:authorize="hasAuthority('USER')" th:action="@{/user}">
                    <button  type="submit" class="btn btn-block btn-link text-left" formaction="/user">User</button>
                </form>
            </div>
        </div>
        <div class="col-9">
            <h2 class="p-2">Admin panel</h2>
            <ul class="nav nav-tabs p-1" role="tablist">
                <li class="nav-item" role="presentation">
                    <a class="nav-link active" id="userlisttab" data-toggle="tab" href="#userlist" role="tab" aria-controls="userlist" aria-selected="true">Users table</a>
                </li>
                <li class="nav-item" role="presentation">
                    <a class="nav-link" id="createnewtab" data-toggle="tab" href="#createnew" role="tab" aria-controls="createnew" aria-selected="false">New User</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="userlist" role="tabpanel" aria-labelledby="userlisttab">
                    <div class="row bg-light ml-3"><h4>All users</h4></div>
                    <table class="table-light table-striped flex-fill w-100 text-center border-top border-bottom">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Name</th>
                                <th>Last Name</th>
                                <th>Age</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Edit</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                    <tbody id="table_body">
                    </tbody>
                </table>
                </div>
                <div class="tab-pane fade" id="createnew" role="tabpanel" aria-labelledby="createnewtab">
                    <div class="row bg-light ml-3"><h4>Add new user</h4></div>
                    <form id="create_form">
                        <div class="offset-4 col-4">
                        <div class="form-group">
                            <label for="name_create">Name:</label>
                            <input class="form-control" type="text" id="name_create">

                            <label for="last_name_create">Last name: </label>
                            <input class="form-control" type="text" id ="last_name_create">

                            <label for="age_create">Age: </label>
                            <input class="form-control" type="number" id="age_create">

                            <label for="email_create">Email: </label>
                            <input class="form-control" type="text" id="email_create">

                            <label for="password_create">Password: </label>
                            <input class="form-control" type="password" id="password_create">

                            <label for="role_create">Role: </label>
                            <select class="form-control" id="role_create" multiple>
                                <option id="user_role_create" value="USER" selected>USER</option>
                                <option id="admin_role_create" value="ADMIN">ADMIN</option>
                            </select>

                            <button type="button" class="btn btn-success" onclick="createUser()">Add new user</button>
                        </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="modal" id="edit" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="col px-1 px-2">
                    <form class="form-group">
                        <div class="modal-header">
                            <h4 class="modal-title text-left">Edit user</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="input-group-sm">
                            <label class="col-form-label" for="id_update">ID:</label>
                            <input class="form-control" type="text" id="id_update" readonly="" name="id" value="">

                            <label for="name_update">First name</label>
                            <input class="form-control" type="text" id="name_update">

                            <label for="last_name_update">Last name</label>
                            <input class="form-control" type="text" id="last_name_update">

                            <label for="age_update">Age</label>
                            <input class="form-control" type="number" id="age_update">

                            <label for="email_update">Email</label>
                            <input class="form-control" type="text" id="email_update">

                            <label for="password_update">Password</label>
                            <input class="form-control" type="password" id="password_update" placeholder="Password">

                            <label for="role_update">Role </label>
                            <select class="custom-select" id="role_update" multiple="">
                                <option id="user_role_update" value="USER">USER</option>
                                <option id="admin_role_update" value="ADMIN">ADMIN</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" onclick="updateUser()" class="btn btn-info">Edit</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="modal" id="delete" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="col px-1 px-2">
                    <form class="form-group">
                        <div class="modal-header">
                            <h4 class="modal-title text-left">Delete user</h4>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="input-group-sm">
                            <label class="col-form-label" for="id_del">ID:</label>
                            <input class="form-control" type="text" id="id_del" readonly="" name="id">

                            <label for="name_del">Name</label>
                            <input class="form-control" type="text" id="name_del" readonly="">

                            <label for="last_name_del">Last name</label>
                            <input class="form-control" type="text" id="last_name_del" readonly="">

                            <label for="age_del">Age</label>
                            <input class="form-control" type="number" id="age_del" readonly="">

                            <label for="email_del">Email</label>
                            <input class="form-control" type="text" id="email_del" readonly="">

                            <label for="password_del">Password</label>
                            <input class="form-control" type="password" id="password_del" readonly="" placeholder="Password" value="">

                            <label for="role_del">Role</label>
                            <select class="custom-select" id="role_del" multiple="" disabled>
                                <option id="user_role_del" value="USER">USER</option>
                                <option id="admin_role_del" value="ADMIN">ADMIN</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" onclick="deleteUser()" class="btn btn-danger">Delete</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

<script>
    $('#edit').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget)
        const id = button.data('userid')
        const name = button.data('username')
        const lastname = button.data('userlastname')
        const age = button.data('userage')
        const email = button.data('useremail')
        const roles = button.data('roles')


        const modal = $(this)
        modal.find('#id_update').val(id)
        modal.find('#name_update').val(name)
        modal.find('#last_name_update').val(lastname)
        modal.find('#age_update').val(age)
        modal.find('#email_update').val(email)
        if (roles.includes("ADMIN")){
            modal.find('#admin_role_update').attr("selected", "selected")
        }
        if (roles.includes("USER")){
            modal.find('#user_role_update').attr("selected", "selected")
        }
    })
</script>

<script>
    $('#delete').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget)
        const id = button.data('userid')
        const name = button.data('username')
        const lastname = button.data('userlastname')
        const age = button.data('userage')
        const email = button.data('useremail')
        const roles = button.data('roles')


        const modal = $(this)
        modal.find('#id_del').val(id)
        modal.find('#name_del').val(name)
        modal.find('#last_name_del').val(lastname)
        modal.find('#age_del').val(age)
        modal.find('#email_del').val(email)
        if (roles.includes("ADMIN")){
            modal.find('#admin_role_del').attr("selected", "selected")
        }
        if (roles.includes("USER")){
            modal.find('#user_role_del').attr("selected", "selected")
        }
    })
</script>

<script>
    async function drawUserTable(){
        let response = await fetch("/admin/rest/users")
        let users = await response.json()
        let table = document.getElementById("table_body")
        table.innerHTML = ""
        for (let userIndex in users){
        let user = users[userIndex]
        table.innerHTML +=
            `<tr>` +
            `<td>${user.id}</td>` +
            `<td>${user.name}</td>` +
            `<td>${user.lastname}</td>` +
            `<td>${user.age}</td>` +
            `<td>${user.email}</td>` +
            `<td>${user.rolesInString}</td>` +
            `<td><button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#edit" ` +
            `data-userid="${user.id}" ` +
            `data-username="${user.name}" ` +
            `data-userlastname="${user.lastname}" ` +
            `data-userage="${user.age}" ` +
            `data-useremail="${user.email}" ` +
            `data-roles="${user.rolesInString}">Edit</button></td>` +
            `<td><button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#delete" ` +
            `data-userid="${user.id}" ` +
            `data-username="${user.name}" ` +
            `data-userlastname="${user.lastname}" ` +
            `data-userage="${user.age}" ` +
            `data-useremail="${user.email}"` +
            `data-roles="${user.rolesInString}">Delete</button></td>` +
            `</tr>`
        }
    }
    drawUserTable()

    async function createUser(){
        const name = document.getElementById("name_create").value
        const lastname = document.getElementById("last_name_create").value
        const age = document.getElementById("age_create").value
        const email = document.getElementById("email_create").value
        const pass = document.getElementById("password_create").value
        let roles = $('#role_create').val()

        let response = await fetch("/admin/rest/users/new", {
            headers: {'Content-Type': 'application/json'},
            method: "POST",
            body: JSON.stringify({name: name, lastname: lastname, age: age, email: email, password: pass, roles: roles})})
        if (response.ok){
            drawUserTable()
            alert('User created!')
        }
    }

    async function deleteUser(){
        const id = document.getElementById("id_del").value
        let response = await fetch("/admin/rest/users/delete", {
            headers: {'Content-Type': 'application/json'},
            method: "DELETE",
            body: JSON.stringify({id: id})})
        if (response.ok){
            drawUserTable()
            $('.modal').modal('hide')
        }
    }

    async function updateUser(){
        const id = document.getElementById("id_update").value
        const name = document.getElementById("name_update").value
        const lastname = document.getElementById("last_name_update").value
        const age = document.getElementById("age_update").value
        const email = document.getElementById("email_update").value
        const pass = document.getElementById("password_update").value
        let roles = $('#role_update').val()


        let response = await fetch("/admin/rest/users/update", {
            headers: {'Content-Type': 'application/json'},
            method: "PATCH",
            body: JSON.stringify({id: id, name: name, lastname: lastname, age: age, email: email, password: pass, roles: roles})})
        if (response.ok){
            drawUserTable()
            $('.modal').modal('hide')
        }
    }
</script>

</body>
</html>